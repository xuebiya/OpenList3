# OpenList 媒体文件访问日志系统

这是一个专门为 OpenList 项目设计的媒体文件访问日志系统，它只记录与视频和图片文件相关的访问日志，过滤掉所有其他类型的请求日志。

## 主要功能

### 1. 专注于媒体文件
- 只记录视频和图片文件的访问日志
- 支持多种常见媒体文件格式（如 mp4、jpg、png 等）
- 完全忽略其他类型的请求日志

### 2. 深度检测
- 直接检查请求路径中的媒体文件扩展名
- 解析 `/api/fs/list` 和 `/api/fs/get` 请求的响应内容
- 检查响应中是否包含媒体文件信息

### 3. 详细日志格式

#### 普通访问日志格式
```
时间：2025年10月8日 14:30:25 访问IP：192.168.1.100 用户：admin 行为：直接播放 访问路径：/movies/video.mp4
```

#### 共享访问日志格式（新增）
```
时间：2025年10月8日 14:30:25 访问IP：192.168.1.100 用户：访客 行为：播放器播放 共享ID：abc123def456 共享创建者：admin 访问路径：/sd/abc123def456/movies/video.mp4
```

#### 访问行为类型说明
- **直接播放**：通过浏览器在线播放媒体文件
- **播放器播放**：通过专业播放器（如 VLC、PotPlayer 等）播放
- **下载**：下载媒体文件到本地
- **浏览器查看**：在浏览器中查看图片等

### 4. 智能访问行为检测（新增）
- **播放器检测**：自动识别 VLC、PotPlayer、MPlayer、Kodi、Plex 等常见播放器
- **Range 请求分析**：通过 Range 请求头判断流式播放行为
- **路径分析**：
  - `/p/*` 路径识别为播放
  - `/d/*` 路径识别为下载或播放（根据 Range 请求）
  - `/sd/*` 共享路径智能判断
- **User-Agent 分析**：区分浏览器、播放器和下载工具
- **文件类型判断**：图片文件默认为浏览器查看

### 5. 共享功能支持
- 自动检测共享访问（通过 `/sd/:sid` 路径）
- 记录共享ID和共享创建者信息
- 区分普通用户访问和共享访问
- 支持访客访问共享内容的日志记录

### 6. 智能去重机制（新增）
- **防止重复日志**：播放器通常会发送多个 Range 请求，系统会自动去重
- **3秒去重窗口**：相同的访问在3秒内只记录一次
- **自动清理缓存**：定期清理过期的访问记录，保持内存效率
- **精确识别**：基于 IP、用户、行为和路径的组合判断是否为重复访问

### 7. 调试模式
- 提供详细的请求和响应信息
- 记录请求体和响应体内容
- 帮助排查问题

## 支持的媒体文件格式

### 图片格式
- jpg/jpeg
- png
- gif
- bmp
- webp
- svg
- tiff
- ico
- heic

### 视频格式
- mp4
- avi
- mkv
- mov
- wmv
- flv
- webm
- m4v
- mpg/mpeg
- 3gp
- rm/rmvb
- ts
- m3u8

## 工作原理

### 1. 直接文件访问
- 检查请求路径是否以支持的媒体文件扩展名结尾
- 如果是，记录访问日志
- 自动检测是否为共享访问

### 2. API 调用
- **对于 `/api/fs/list` 请求**：
  - 捕获请求体和响应体
  - 解析响应中的文件列表
  - 检查是否包含媒体文件
  - 如果包含，记录日志并列出媒体文件路径
  - 识别共享路径（路径以共享ID开头）
  
- **对于 `/api/fs/get` 请求**：
  - 捕获请求体和响应体
  - 解析响应中的文件信息
  - 检查是否为媒体文件
  - 如果是，记录日志并显示文件路径
  - 识别共享路径

### 3. 共享访问检测
- 检查上下文中是否有共享ID（由 `SharingIdParse` 中间件设置）
- 检查请求路径是否为共享下载路径（`/sd/:sid`）
- 检查请求体中的路径是否包含共享ID
- 从数据库获取共享创建者信息

### 4. 其他请求
- 完全忽略，不记录日志

## 使用方式

系统已经在服务器入口处配置好，无需额外设置。它会自动根据是否为调试模式选择合适的日志中间件：

```go
// 在 cmd/server.go 中
if flags.Debug || flags.Dev {
    r.Use(middlewares.MediaLoggerWithDebug(), gin.RecoveryWithWriter(log.StandardLogger().Out))
} else {
    r.Use(middlewares.MediaLoggerMiddleware(), gin.RecoveryWithWriter(log.StandardLogger().Out))
}
```

## 日志输出示例

### 1. 浏览器直接播放媒体文件
```
时间：2025年10月8日 14:30:25 访问IP：192.168.1.100 用户：admin 行为：直接播放 访问路径：/d/movies/video.mp4
```

### 2. 使用播放器播放（如 VLC）
```
时间：2025年10月8日 14:30:25 访问IP：192.168.1.100 用户：admin 行为：播放器播放 访问路径：/d/movies/video.mp4
```

### 3. 下载媒体文件
```
时间：2025年10月8日 14:30:25 访问IP：192.168.1.100 用户：admin 行为：下载 访问路径：/d/movies/video.mp4
```

### 4. 通过共享链接播放媒体文件
```
时间：2025年10月8日 14:30:25 访问IP：192.168.1.100 用户：访客 行为：直接播放 共享ID：abc123def456 共享创建者：admin 访问路径：/sd/abc123def456/movies/video.mp4
```

### 5. 播放器访问共享媒体文件
```
时间：2025年10月8日 14:30:25 访问IP：192.168.1.100 用户：访客 行为：播放器播放 共享ID：abc123def456 共享创建者：admin 访问路径：/sd/abc123def456/movies/video.mp4
```

### 6. 浏览器查看图片
```
时间：2025年10月8日 14:30:43 访问IP：192.168.1.100 用户：admin 行为：浏览器查看 访问路径：/photos/image.jpg
```

### 7. 目录列表中包含媒体文件
```
时间：2025年10月8日 14:30:43 访问IP：192.168.1.100 用户：admin 行为：浏览器查看 访问路径：/movies/video1.mp4
时间：2025年10月8日 14:30:43 访问IP：192.168.1.100 用户：admin 行为：浏览器查看 访问路径：/movies/video2.mkv
```

## 自定义扩展

### 添加更多媒体文件格式

如果需要支持更多的媒体文件格式，可以在 `server/middlewares/media_logger.go` 文件中的 `mediaExtensions` 变量中添加。

例如：
```go
var mediaExtensions = map[string]bool{
    // ... 现有格式 ...
    ".webp": true,  // 新增格式
    ".avif": true,  // 新增格式
}
```

### 添加更多播放器识别

如果需要识别更多的播放器，可以在 `playerIdentifiers` 数组中添加：

```go
var playerIdentifiers = []string{
    // ... 现有播放器 ...
    "YourPlayer",     // 添加您的播放器标识
    "CustomPlayer",   // 自定义播放器
}
```

### 自定义行为检测逻辑

可以修改 `detectAccessBehavior` 函数来调整行为检测逻辑，例如：
- 调整路径判断规则
- 修改 Range 请求的处理方式
- 添加特定的判断条件

## 调试模式

在调试模式下，系统会输出更多详细信息，包括请求体和响应体内容，帮助排查问题。要启用调试模式，只需设置 `flags.Debug` 或 `flags.Dev` 为 `true`。

## 与原有功能的兼容性

- **完全兼容**：新的日志系统不影响 OpenList 的任何现有功能
- **共享功能支持**：完全支持新版本的共享功能，并能正确识别和记录共享访问
- **用户认证**：正确识别登录用户、访客和共享访问者
- **性能优化**：只记录媒体文件访问，减少日志量，提高系统性能

## 技术细节

### 访问行为检测逻辑

#### 1. 播放器检测（优先级最高）
检测 User-Agent 中是否包含以下播放器标识：
- **桌面播放器**：VLC, MPlayer, mpv, PotPlayer, KMPlayer, IINA
- **媒体中心**：Kodi, Plex, Emby, Jellyfin
- **系统播放器**：QuickTime, Windows-Media-Player, RealPlayer
- **流媒体引擎**：FFmpeg (lavf), GStreamer, NSPlayer
- **移动播放器**：stagefright, ExoPlayer, AppleCoreMedia

#### 2. 路径分析
- **`/p/*` 路径**：代理播放，标记为"直接播放"
- **`/d/*` 路径**：
  - 有 Range 请求 + 浏览器 → "直接播放"
  - 其他情况 → "下载"
- **`/sd/*` 路径**（共享）：
  - 有 Range 请求 + 浏览器 → "直接播放"
  - 其他情况 → "下载"

#### 3. Range 请求头分析
- 有 Range 请求 + 浏览器 User-Agent → "直接播放"
- 有 Range 请求 + 非浏览器 → "播放器播放"

#### 4. 文件类型判断
- 图片文件（jpg, png, gif 等） → "浏览器查看"
- API 调用（`/api/*`） → "浏览器查看"

#### 5. 浏览器识别
识别以下浏览器标识：
- Mozilla, Chrome, Safari, Firefox, Edge, Opera
- Internet Explorer (MSIE, Trident)
- 排除：curl, wget, axios, python, java, go-http-client 等工具

### 共享ID检测优先级
1. 从 Gin Context 中获取（由 `SharingIdParse` 中间件设置）
2. 从请求路径中提取（`/sd/:sid` 格式）
3. 从请求体中的路径提取（路径以共享ID开头）

### 共享创建者信息获取
- 通过共享ID从数据库查询 `SharingDB` 表
- 根据 `CreatorId` 字段查询 `User` 表获取创建者用户名
- 如果查询失败，显示"未知创建者"

### 用户识别优先级
1. 从 Request Context 中获取用户（通过 conf.UserKey）
2. 从 Gin Context 中获取用户（兼容性）
3. 区分访客用户和普通用户
4. 默认为"访客"（未登录或访客模式）

### 日志去重机制
- **去重键生成**：使用 MD5 哈希 `IP|用户|行为|路径` 的组合
- **去重时间窗口**：3秒内的重复访问会被过滤
- **缓存清理**：自动清理10秒前的缓存记录
- **并发安全**：使用读写锁保护缓存访问

**为什么需要去重？**
- 播放器（如 VLC）通常会发送多个 Range 请求来分段加载视频
- 浏览器可能会预加载或重试请求
- 避免日志文件被大量重复记录填满

## 注意事项

1. 日志文件位置取决于系统的日志配置
2. 大量媒体文件访问可能产生大量日志，请定期清理
3. 共享ID长度固定为12个字符
4. 日志格式为纯文本，方便解析和分析

